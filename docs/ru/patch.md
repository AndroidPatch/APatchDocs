# Патчинг

## Автоматический патчинг

1. Загрузите последнюю версию менеджера APatch с [GitHub](https://github.com/bmax121/APatch/releases).

2. Нажмите на кнопку ![Patch Button](/PButton.png) в правом верхнем углу главной страницы, чтобы установить суперключ. Суперключ должен состоять из **цифр и латинских букв** и иметь длину не менее **8 символов**. В дальнейшем он будет использоваться для разблокировки привилегий root.

:::warning
Категорически запрещено устанавливать легкие ключи по типу `12345678`. Последние версии APatch [требуют использования сложных ключей](/ru/warn).
:::

3. Выберите `boot.img` вашего ПЗУ, подтвердите и дождитесь завершения патча. После успешного завершения патча на экране появится путь к исправленному boot.img. Например: `/storage/emulated/0/Download/apatch_version_version_randomletter.img`.

Наконец, вы можете [прошить](/ru/flash) этот образ.

## Патчинг вручную

Когда KernelPatch обновляется, а APatch Manager остается неизменным, вы пропатчить ядро вручную.

Вы можете обратиться к [KernelPatch](https://github.com/bmax121/KernelPatch/releases), чтобы получить последние файлы `KP`.

### На Windows

1. Скачайте `kptools-win.zip`, `kpimg-android` и `magiskboot`. Распакуйте их в тот же каталог, где у вас хранится заранее подготовленный boot.img вашего устройства.

2. Выполните эту команду:

```
magiskboot.exe unpack boot.img
```

чтобы распаковать `boot.img` и получить файл ядра. Переименуйте ядро в **kernel-b**. (kernel-b может быть любым сторонним ядром, но сторонним ядра не дают никаких гарантий и не будут поддерживаться).

Пользователи Windows могут установить патч, используя `CMD` и `PowerShell`.

Выполните эту команду, чтобы установить патч:

```
kptools-x86_64-win.exe -p --image kernel-b --skey "YourKey" --kpimg kpimg-android --out kernel
```

В качестве альтернативы, рекомендуется использовать `WSL` с `Linux` для установки патчей:

```
./kptools-linux -p --image kernel-b --skey "YourKey" --kpimg kpimg-android --out kernel
```

Если во время установки патча не было обнаружено ошибок, выполните эту команду:

```
magiskboot.exe repack boot.img
```

чтобы упаковать и сгенерировать образ. Сгенерированный `new-boot.img` - это готовый пропатченный образ.

---

### На Linux

1. Скачайте `kptools-linux`, `kpimg-android` и `magiskboot`.

2. Выполните эту команду:

```
magiskboot unpack boot.img
```

чтобы распаковать `boot.img` и получить файл ядра. Переименуйте ядро в **kernel-b** (повторяем ещё раз, kernel-b может быть любым сторонним ядром, но сторонние ядра не имеют никаких гарантий и не будут поддерживаться).

Выполните эту команду, чтобы установить патч:

```
./kptools-linux -p --image kernel-b --skey "YourKey" --kpimg kpimg-android --out kernel
```

Если во время установки патча не было обнаружено ошибок, выполните эту команду:

```
magiskboot repack boot.img
```

чтобы упаковать и сгенерировать образ. Сгенерированный `new-boot.img` - это готовый пропатченный образ.

::: warning
**Подчеркнем еще раз: устанавливать слабые ключи типа `12345678` СТРОГО ЗАПРЕЩЕНО.**.
:::

# Команды и комментарии KP:

::: info
Вы можете нажать [сюда](https://exame.apatch.top/) чтобы попробовать.
:::

```
Команды:
  -h, --help                       Вывод этого сообщения.
  -v, --version                    Вывод номера версии. Вывести версию kpimg, если указано -k.
  -p, --patch                      Патч или обновление патча образа ядра(-i) с указанными kpimg(-k) и суперключа(-s).
  -u, --unpatch                    Удаление патча из образа ядра(-i)
  -r, --reset-skey                 Сброс суперключа патченного образа(-i).
  -d, --dump                       Выгрузите kallsyms-информацию ядра(-i).
  -l, --list                       Вывести всю информацию об патчах образа ядра, если указано (-i).
                                   Вывод информации о дополнительных элементах, если указано (-M).
                                   Вывод информации об образе KernelPatch, если указано (-k).
Опции:
  -i, --image PATH                 Путь к образу ядра.
  -k, --kpimg PATH                 Путь к образу KernelPatch.
  -s, --skey KEY                   Установка суперключа и сохранение его непосредственно в файле boot.img.
  -S, --root-skey KEY              Установка root-superkey, который использует проверку хэша, и может быть изменен динамически.
  -o, --out PATH                   Путь к патченному образу.
  -a  --addition KEY=VALUE         Добавление дополнительной информации.
  -K, --kpatch PATH                Встраивание исполняемого двоичного файла kpatch в патчи.
  -M, --embed-extra-path PATH      Вставка нового дополнительного элемента.
  -E, --embeded-extra-name NAME    Сохранение и модификация встроенного дополнительного элемента.
  -T, --extra-type TYPE            Установка типа предыдущего дополнительного элемента.
  -N, --extra-name NAME            Установка имени предыдущего дополнительного элемента.
  -V, --extra-event EVENT          Установка события запуска предыдущего дополнительного элемента.
  -A, --extra-args ARGS            Установка аргумента предыдущего дополнительного элемента.
  -D, --extra-detach               Отсоединение предыдущего дополнительный элемент от патчей.
```
